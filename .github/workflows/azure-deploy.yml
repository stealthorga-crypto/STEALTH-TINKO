name: Deploy STEALTH-TINKO to Azure

on:
  push:
    branches: [main, develop, staging]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        default: 'dev'
        type: choice
        options: [dev, staging, prod]

env:
  PYTHON_VERSION: '3.11'

jobs:
  # =======================================
  # Determine Environment
  # =======================================
  determine-environment:
    name: Determine Environment
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.env.outputs.environment }}
      resource-group: ${{ steps.env.outputs.resource-group }}
      app-name: ${{ steps.env.outputs.app-name }}
    
    steps:
    - name: Determine environment
      id: env
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          ENV="${{ inputs.environment }}"
        elif [ "${{ github.ref }}" = "refs/heads/main" ]; then
          ENV="prod"
        elif [ "${{ github.ref }}" = "refs/heads/staging" ]; then
          ENV="staging"
        else
          ENV="dev"
        fi
        
        echo "environment=${ENV}" >> $GITHUB_OUTPUT
        echo "resource-group=stealth-tinko-${ENV}-rg" >> $GITHUB_OUTPUT
        echo "app-name=stealth-tinko-${ENV}-app" >> $GITHUB_OUTPUT

  # =======================================
  # Deploy Infrastructure
  # =======================================
  deploy-infrastructure:
    name: Deploy Infrastructure
    runs-on: ubuntu-latest
    needs: [determine-environment]
    environment: ${{ needs.determine-environment.outputs.environment }}
    outputs:
      web-app-name: ${{ steps.deploy.outputs.webAppName }}
      key-vault-name: ${{ steps.deploy.outputs.keyVaultName }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
    
    - name: Create Resource Group
      run: |
        az group create \
          --name ${{ needs.determine-environment.outputs.resource-group }} \
          --location "East US 2" \
          --tags Environment=${{ needs.determine-environment.outputs.environment }} Application=STEALTH-TINKO
        echo "‚úÖ Resource group created successfully"
    
    - name: Deploy Infrastructure
      id: deploy
      run: |
        DEPLOYMENT_NAME="stealth-tinko-deployment-$(date +%Y%m%d-%H%M%S)"
        UNIQUE_SUFFIX=$(echo $RANDOM | md5sum | head -c 6)
        
        az deployment group create \
          --name $DEPLOYMENT_NAME \
          --resource-group ${{ needs.determine-environment.outputs.resource-group }} \
          --template-file ./infra/azure/main.bicep \
          --parameters \
            environment=${{ needs.determine-environment.outputs.environment }} \
            applicationName=stealth-tinko \
            location="East US 2" \
            adminEmail="admin@stealthorga-crypto.com" \
            gitHubRepo="https://github.com/stealthorga-crypto/STEALTH-TINKO" \
            postgresAdminUser="stealthadmin" \
            postgresAdminPassword="${{ secrets.DATABASE_PASSWORD }}" \
            emailDomain="stealthorga-crypto.com" \
          --verbose
        
        # Get outputs
        WEB_APP_NAME=$(az deployment group show \
          --resource-group ${{ needs.determine-environment.outputs.resource-group }} \
          --name $DEPLOYMENT_NAME \
          --query "properties.outputs.webAppName.value" -o tsv)
        
        KEY_VAULT_NAME=$(az deployment group show \
          --resource-group ${{ needs.determine-environment.outputs.resource-group }} \
          --name $DEPLOYMENT_NAME \
          --query "properties.outputs.keyVaultName.value" -o tsv)
        
        echo "webAppName=${WEB_APP_NAME}" >> $GITHUB_OUTPUT
        echo "keyVaultName=${KEY_VAULT_NAME}" >> $GITHUB_OUTPUT
        echo "‚úÖ Infrastructure deployed successfully"

  # =======================================
  # Configure App Service
  # =======================================
  configure-app-service:
    name: Configure App Service
    runs-on: ubuntu-latest
    needs: [deploy-infrastructure, determine-environment]
    
    steps:
    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
    
    - name: Store secrets in Key Vault
      run: |
        KEYVAULT_NAME="${{ needs.deploy-infrastructure.outputs.key-vault-name }}"
        
        az keyvault secret set \
          --vault-name "${KEYVAULT_NAME}" \
          --name "DATABASE-PASSWORD" \
          --value "${{ secrets.DATABASE_PASSWORD }}"
        
        az keyvault secret set \
          --vault-name "${KEYVAULT_NAME}" \
          --name "JWT-SECRET-KEY" \
          --value "${{ secrets.JWT_SECRET_KEY }}"
        
        echo "‚úÖ Secrets stored in Key Vault"
    
    - name: Configure App Service settings
      run: |
        APP_NAME="${{ needs.deploy-infrastructure.outputs.web-app-name }}"
        KEYVAULT_NAME="${{ needs.deploy-infrastructure.outputs.key-vault-name }}"
        
        az webapp config appsettings set \
          --resource-group ${{ needs.determine-environment.outputs.resource-group }} \
          --name "${APP_NAME}" \
          --settings \
            ENVIRONMENT="${{ needs.determine-environment.outputs.environment }}" \
            DATABASE_PASSWORD="@Microsoft.KeyVault(VaultName=${KEYVAULT_NAME};SecretName=DATABASE-PASSWORD)" \
            JWT_SECRET_KEY="@Microsoft.KeyVault(VaultName=${KEYVAULT_NAME};SecretName=JWT-SECRET-KEY)" \
            PYTHONPATH="/home/site/wwwroot" \
            SCM_DO_BUILD_DURING_DEPLOYMENT="true"
        
        echo "‚úÖ App Service configured"

  # =======================================
  # Deploy Application
  # =======================================
  deploy-application:
    name: Deploy Application
    runs-on: ubuntu-latest
    needs: [configure-app-service, deploy-infrastructure, determine-environment]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
    
    - name: Deploy to Azure App Service
      uses: azure/webapps-deploy@v2
      with:
        app-name: ${{ needs.deploy-infrastructure.outputs.web-app-name }}
        package: .
    
    - name: Run database migrations
      run: |
        APP_NAME="${{ needs.deploy-infrastructure.outputs.web-app-name }}"
        
        # Configure startup command for migrations
        az webapp config set \
          --resource-group ${{ needs.determine-environment.outputs.resource-group }} \
          --name "${APP_NAME}" \
          --startup-file "python startup.py"
        
        echo "‚úÖ Application deployed and migrations configured"

  # =======================================
  # Verify Deployment
  # =======================================
  verify-deployment:
    name: Verify Deployment
    runs-on: ubuntu-latest
    needs: [deploy-application, deploy-infrastructure, determine-environment]
    
    steps:
    - name: Health check
      run: |
        APP_NAME="${{ needs.deploy-infrastructure.outputs.web-app-name }}"
        APP_URL="https://${APP_NAME}.azurewebsites.net"
        
        echo "‚è≥ Waiting for application to start..."
        sleep 120
        
        echo "üîç Checking health endpoint: ${APP_URL}/health"
        response=$(curl -s -o /dev/null -w "%{http_code}" "${APP_URL}/health" || echo "000")
        
        if [ "${response}" = "200" ]; then
          echo "‚úÖ Health check passed"
          echo "üöÄ Application successfully deployed at: ${APP_URL}"
        else
          echo "‚ùå Health check failed with status: ${response}"
          echo "üìã Deployment summary:"
          echo "   App Name: ${APP_NAME}"
          echo "   URL: ${APP_URL}"
          echo "   Check the Azure portal for logs and troubleshooting"
          exit 1
        fi