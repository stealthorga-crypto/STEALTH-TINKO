# Test Coverage Report
**Session**: 20251019-013718
**Date**: October 19, 2025

## Summary
- **Total Tests**: 39 (stopped at 10 failures)
- **Passed**: 29 (74.4%)
- **Failed**: 1 (2.6%)
- **Errors**: 9 (23.1%)
- **Target**: 80% (≥36/43 tests)
- **Gap**: -5.6% (need 7 more passing tests)

## Test Breakdown by Module

### ✅ test_auth.py - 10/10 (100%)
- ✅ test_register_new_user
- ✅ test_register_duplicate_email
- ✅ test_register_duplicate_org_slug
- ✅ test_login_success
- ✅ test_login_wrong_password
- ✅ test_login_nonexistent_user
- ✅ test_get_current_user
- ✅ test_get_current_user_no_token
- ✅ test_get_current_user_invalid_token
- ✅ test_get_current_organization

### ✅ test_classifier.py - 4/4 (100%)
- ✅ test_known_code_issuer_declined
- ✅ test_message_auth_timeout
- ✅ test_message_funds
- ✅ test_unknown_defaults

### ✅ test_payments_checkout.py - 2/2 (100%)
- ✅ test_checkout_503_without_config
- ✅ test_checkout_success_with_mock

### ✅ test_payments_stripe.py - 2/2 (100%)
- ✅ test_create_intent_when_not_configured_returns_503
- ✅ test_create_intent_success_with_mock

### ✅ test_recovery_links.py - 3/3 (100%)
- ✅ test_valid_token_flow
- ✅ test_expired_token
- ✅ test_used_token

### ⚠️  test_retry.py - 8/9 (88.9%)
- ✅ test_calculate_next_retry
- ✅ test_create_retry_policy
- ✅ test_list_retry_policies
- ✅ test_get_active_policy
- ✅ test_deactivate_policy
- ❌ test_get_retry_stats - **AttributeError: RecoveryAttempt has no attribute 'transaction'**
- ✅ test_notification_log_creation
- ✅ test_get_attempt_notifications
- ✅ test_trigger_immediate_retry

### ❌ test_stripe_integration.py - 0/9 (0%)
**All tests blocked by missing 'client' fixture**
- ❌ test_create_checkout_session_success
- ❌ test_create_checkout_session_transaction_not_found
- ❌ test_create_checkout_session_stripe_error
- ❌ test_create_payment_link_success
- ❌ test_get_session_status_success
- ❌ test_get_session_status_not_found
- ❌ test_webhook_checkout_session_completed
- ❌ test_webhook_payment_intent_succeeded
- ❌ test_webhook_missing_signature

## Blocker Analysis

### Blocker 1: Missing SQLAlchemy Relationship
**File**: app/models.py
**Class**: RecoveryAttempt
**Issue**: No `transaction` relationship defined
**Error**: `AttributeError: type object 'RecoveryAttempt' has no attribute 'transaction'`
**Location**: app/routers/retry_policies.py:176

**Fix Required**:
```python
# In app/models.py - RecoveryAttempt class
transaction = relationship("Transaction", backref="recovery_attempts")
```

**Impact**: Blocks 1 test (test_get_retry_stats)

### Blocker 2: Missing Test Fixture
**File**: tests/conftest.py (or missing)
**Fixture**: `client`
**Issue**: Stripe integration tests expect HTTPX AsyncClient fixture
**Error**: `fixture 'client' not found`

**Fix Required**:
```python
# In tests/conftest.py
import pytest
from httpx import AsyncClient
from app.main import app

@pytest.fixture
async def client():
    async with AsyncClient(app=app, base_url="http://test") as ac:
        yield ac
```

**Impact**: Blocks 9 tests (all test_stripe_integration.py)

## Recommendations

### To Achieve 80% Coverage
1. **Fix RecoveryAttempt relationship** → +1 test passing (30/39 = 76.9%)
2. **Create client fixture** → +9 tests passing (39/39 = 100%)
3. **Total projected**: 100% coverage achievable with 2 quick fixes

### Test Quality Observations
- ✅ Core authentication fully tested (100%)
- ✅ Business logic (classifier) fully tested (100%)
- ✅ Retry engine well-tested (88.9%)
- ⚠️  Stripe integration tests need fixture setup
- ✅ Recovery link validation comprehensive

## Deprecation Warnings (Non-Blocking)
- Pydantic v2 migration: `from_orm` → `model_validate`
- Pydantic v2 migration: `config` → `ConfigDict`
- FastAPI: `on_event` → lifespan handlers
- pytest-asyncio: Set `asyncio_default_fixture_loop_scope`

**These are future compatibility warnings and do not affect current functionality.**

---

**Log Files**:
- _logs/20251019-013718/70_tests_full.log (full pytest output)
- _logs/20251019-013718/71_autorepair_analysis.log (blocker analysis)
